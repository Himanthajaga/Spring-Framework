<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Place Order Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">Place Order Management</a>
    <span class="navbar-toggler-icon"></span>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
            <a class="nav-link" href="index.html">Home <span class="sr-only"></span></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="item.html">Items</a>
            </li>
            <li class="nav-item">
        </ul>
    </div>
</nav>
<div class="container">
    <div class="row">
        <div class="col-md-6">
            <form id="itemForm" class="mt-4">
                <div class="form-group">
                    <label for="orderID" class="form-label">Order ID:</label>
                    <input type="text" class="form-control" id="orderID" placeholder="Order ID">
                </div>
                <label for="customerID" class="form-label">Customer ID:</label>
                    <input type="text" class="form-control" id="customerID" placeholder="Customer ID" readonly>
                <div class="mb-3 p-1">
                    <label for="customerName" class="form-label">Customer Name:</label>
                    <select class="form-select" id="customerName">
                        <option selected>Select Customer Name</option>
                    </select>
                </div>
                <div class="mb-3 p-1">
                    <label for="orderDate" class="form-label">Order Date:</label>
                    <input type="date" class="form-control" id="orderDate" placeholder="Order Date">
                </div>
                <div class="mb-3 p-1">
                    <label for="itemCode" class="form-label">Item Code:</label>
                    <input type="text" class="form-control" id="itemCode" placeholder="Item Code" readonly>
                </div>
                <div class="mb-3 p-1">
                    <label for="itemName" class="form-label">Item Name:</label>
                    <select class="form-select" id="itemName">
                        <option selected>Select Item Name</option>
                    </select>
                </div>
                <div class="mb-3 p-1">
                    <label for="qty" class="form-label">Qty:</label>
                    <input type="number" class="form-control" id="qty" placeholder="Qty">
                </div>
                <div class="mb-3 p-1">
                    <label for="unitPrice" class="form-label">Unit Price:</label>
                    <input type="number" class="form-control" id="unitPrice" placeholder="Unit Price" readonly>
                </div>
                <div class="mb-3 p-1">
                    <label for="price" class="form-label">Price:</label>
                    <input type="number" class="form-control" id="price" placeholder="Price" readonly>
                </div>
                <div class=" m-auto">
                    <button type="button" class="btn btn-outline-primary" id="AddItem">ADD ITEM</button>
                    <button type="button" class="btn btn-outline-success" id="AddOrder">PLACE ORDER</button>
                </div>
            </form>
        </div>
        <div class="col-md-6">
            <section>
                <table class="table table-hover table-bordered border-primary w-75 m-auto">
                    <thead>
                    <tr>
                        <th scope="col">ORDER ID</th>
                        <th scope="col">CUSTOMER ID</th>
                        <th scope="col">ITEM CODE</th>
                        <th scope="col">ITEM NAME</th>
                        <th scope="col">QTY</th>
                        <th scope="col">UNIT PRICE</th>
                        <th scope="col">PRICE</th>
                        <th scope="col">Actions</th>
                    </tr>
                    </thead>
                    <tbody id="orderTableBody">

                    </tbody>
                </table>
            </section>
        </div>
    </div>
    <!-- Order Summary Modal -->
    <div class="modal fade" id="orderSummaryModal" tabindex="-1" aria-labelledby="orderSummaryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderSummaryModalLabel">Order Summary</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-hover table-bordered border-primary">
                        <thead>
                        <th scope="col">ORDER ID</th>
                        <th scope="col">CUSTOMER ID</th>
                        <th scope="col">ITEM CODE</th>
                        <th scope="col">ITEM NAME</th>
                        <th scope="col">QTY</th>
                        <th scope="col">UNIT PRICE</th>
                        <th scope="col">PRICE</th>
                        </tr>
                        </thead>
                        <tbody id="orderSummaryBody">
                        <!-- Order summary rows will be added here dynamically -->
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="confirmOrder">Confirm Order</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        $(document).ready(function () {
            loadCustomers();
            loadItems();
            $("#customerName").change(function () {
                const selectedCustomer = $(this).val();
                if (selectedCustomer !== "Select Customer Name") {
                    $("#customerID").val(selectedCustomer);
                } else {
                    $("#customerID").val('');
                }
            });
            $("#itemName").change(function () {
                const selectedItem = $(this).val();
                const selectedOption = $(this).find(':selected');
                $("#itemCode").val(selectedItem);
                $("#unitPrice").val(selectedOption.data('price'));
                updatePrice();
            });

            $("#qty").on('input', function () {
                updatePrice();
            });

            $("#AddItem").click(function () {
                if (validateForm()) {
                    let orderID = $("#orderID").val();
                    let customerID = $("#customerID").val();
                    let itemCode = $("#itemCode").val();
                    let itemName = $("#itemName option:selected").text();
                    let qty = $("#qty").val();
                    let unitPrice = $("#unitPrice").val();
                    let price = $("#price").val();

                    let row = `<tr>
                <td>${orderID}</td>
                <td>${customerID}</td>
                <td>${itemCode}</td>
                <td>${itemName}</td>
                <td>${qty}</td>
                <td>${unitPrice}</td>
                <td>${price}</td>
                <td><button class='btn btn-danger delete-btn'>Delete</button></td>
            </tr>`;
                    $("#orderTableBody").append(row);
                }
            });

            $("#orderTableBody").on('click', '.delete-btn', function () {
                $(this).closest('tr').remove();
            });

            $("#AddOrder").click(function () {
                if ($("#orderTableBody tr").length === 0) {
                    alert("Please add at least one item to the order.");
                    return;
                }
                let orderSummaryBody = $("#orderSummaryBody");
                orderSummaryBody.empty();
                $("#orderTableBody tr").each(function () {
                    let row = $(this).clone();
                    row.find('td:last').remove(); // Remove the delete button
                    orderSummaryBody.append(row);
                });
                $("#orderSummaryModal").modal('show');
            });

            $("#confirmOrder").click(function () {
                let orderID = $("#orderID").val();
                let customerID = $("#customerID").val();
                let orderDate = $("#orderDate").val();
                let orderDetails = [];

                $("#orderTableBody tr").each(function () {
                    let itemCode = $(this).find("td:eq(2)").text();
                    let qty = $(this).find("td:eq(4)").text();
                    let unitPrice = $(this).find("td:eq(5)").text();

                    orderDetails.push({
                        itemCode: itemCode,
                        qty: qty,
                        unitPrice: unitPrice
                    });
                });

                let order = {
                    oid: orderID,
                    customerId: customerID,
                    date: orderDate,
                    orderDetails: orderDetails
                };

                $.ajax({
                    url: 'http://localhost:8080/api/v1/order/place',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(order),
                    success: function (response) {
                        alert("Order placed successfully!");
                        clearOrderForm();
                    },
                    error: function (error) {
                        console.error('Error placing order:', error);
                        alert("Failed to place order. Please try again.");
                    }
                });
            })

            function validateForm() {
                let isValid = true;
                let orderID = $("#orderID").val();
                let customerID = $("#customerID").val();
                let itemCode = $("#itemCode").val();
                let qty = $("#qty").val();

                if (!orderID) {
                    alert("Order ID is required.");
                    isValid = false;
                }
                if (!customerID || customerID === "0") {
                    alert("Customer ID is required.");
                    isValid = false;
                }
                if (!itemCode) {
                    alert("Item Code is required.");
                    isValid = false;
                }
                if (!qty || qty <= 0) {
                    alert("Quantity must be greater than zero.");
                    isValid = false;
                }

                return isValid;
            }

            function loadCustomers() {
                $.ajax({
                    url: 'http://localhost:8080/api/v1/customer/get',
                    type: 'GET',
                    success: function (response) {
                        if (response.data && Array.isArray(response.data)) {
                            const customers = response.data;
                            const customerSelect = $('#customerName');
                            customerSelect.empty();
                            customerSelect.append('<option selected>Select Customer Name</option>');
                            customers.forEach(customer => {
                                customerSelect.append(`<option value="${customer.id}">${customer.name}</option>`);
                            });
                        } else {
                            console.error('Invalid response format:', response);
                        }
                    },
                    error: function (error) {
                        console.error('Error fetching customers:', error);
                    }
                });
            }

            function loadItems() {
                $.ajax({
                    url: 'http://localhost:8080/api/v1/item/get',
                    type: 'GET',
                    success: function (response) {
                        if (response.data && Array.isArray(response.data)) {
                            const items = response.data;
                            const itemSelect = $('#itemName');
                            itemSelect.empty();
                            itemSelect.append('<option selected>Select Item Name</option>');
                            items.forEach(item => {
                                itemSelect.append(`<option value="${item.code}" data-price="${item.unitPrice}">${item.description}</option>`);
                            });
                        } else {
                            console.error('Invalid response format:', response);
                        }
                    },
                    error: function (error) {
                        console.error('Error fetching items:', error);
                    }
                });
            }

            function updatePrice() {
                const selectedItem = $('#itemName').find(':selected');
                const unitPrice = selectedItem.data('price');
                const qty = $('#qty').val();
                const price = unitPrice * qty;
                $('#price').val(price);
            }

            function clearOrderForm() {
                $("#orderID").val('');
                $("#customerID").val('');
                $("#customerName").val('Select Customer Name');
                $("#itemCode").val('');
                $("#itemName").val('Select Item Name');
                $("#qty").val('');
                $("#unitPrice").val('');
                $("#price").val('');
                $("#orderTableBody").empty();
            }
        });
    </script>
</div>
</body>
</html>